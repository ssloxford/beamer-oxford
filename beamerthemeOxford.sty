% TODO: investigate mode specifications for handout and note page generation
% TODO: fix warnings

\ProvidesPackage{beamerthemeOxford}[2022/06/15]
\RequirePackage{ifthen}

\def\altlogo{}
\DeclareOptionBeamer{altlogo}{\def\altlogo{#1}}

\def\havefoundrysterling{true}
\DeclareOptionBeamer{nofoundrysterling}{\def\havefoundrysterling{false}}

\def\havesidebar{true}
\DeclareOptionBeamer{hidesidebar}{\def\havesidebar{false}}

\def\havefootline{true}
\DeclareOptionBeamer{hidefootline}{\def\havefootline{false}}

\def\haveframenumber{true}
\DeclareOptionBeamer{hideframenumber}{\def\haveframenumber{false}}

\DeclareOptionBeamer{sidebarwidth}
{\PassOptionsToPackage{width=#1}{beamerouterthemesidebar}}

\DeclareOptionBeamer{hideothersubsections}
{\PassOptionsToPackage{hideothersubsections=#1}{beamerouterthemesidebar}}

\DeclareOptionBeamer{hideallsubsections}
{\PassOptionsToPackage{hideallsubsections=#1}{beamerouterthemesidebar}}

\def\postermode{false}
\DeclareOptionBeamer{postermode}{
  \def\postermode{true}
  \def\havesidebar{false}
  \def\havefootline{false}
  \def\haveframenumber{false}
}

\ProcessOptionsBeamer

% Only set these variables in presentation mode
\mode<presentation>
  % TODO: apparently there's a dark mode we could use?
  \ifthenelse{\equal{\havesidebar}{true}}%
    {\useoutertheme[height=0pt,left]{sidebar}}
    {}
  \usecolortheme{Oxford}
  \useinnertheme{circles}
  \setbeamertemplate{frametitle}[default][right]
\mode<all>

% Set font
\usepackage{fontspec}
\ifthenelse{\equal{\havefoundrysterling}{true}}%
  {\setsansfont[
    BoldFont={FoundrySterling-Bold},
    ItalicFont={FoundrySterling-BookItalic}
  ]{FoundrySterling-Book}}
  {}
\usefonttheme[onlymath]{serif}
%\newfontfamily\foo[options]{FoundrySterling-MediumExpert}

% Set these variables in poster mode
\ifthenelse{\equal{\postermode}{true}}%
  {
    \usecaptiontemplate{\small\structure{\insertcaptionname~\insertcaptionnumber: }\insertcaption} % A fix for figure numbering TODO: required?
 
    \setbeamerfont{footline}{size=\large,series=\tt}
    %\setbeamerfont{block title}{size=\large,series=\bf}
    %\setbeamerfont{title in headline}{size=\large,family=\foo}

%    \setbeamertemplate{block begin}{
%      \vskip.75ex
%      \begin{beamercolorbox}[ht=3.5ex,dp=0.5ex,center,leftskip=-1em,colsep*=.75ex]{block title}%
%        \usebeamerfont*{block title}%
%        \vspace{-7pt}
%        {\hspace{-21pt}\phantom{Gg}\insertblocktitle}% phantom because of baseline problem
%      \end{beamercolorbox}%
%      {\ifbeamercolorempty[bg]{block body}{}{\nointerlineskip\vskip-0.5pt}}%
%      \usebeamerfont{block body}%
%      \begin{beamercolorbox}[leftskip=10pt,colsep*=.75ex,sep=0.5ex,vmode]{block body}%
%        \justifying
%        \ifbeamercolorempty[bg]{block body}{\vskip-.25ex}{\vskip-.75ex}\vbox{}%
%      }
%      \setbeamertemplate{block end}{
%      \end{beamercolorbox}
%    }

    \setbeamertemplate{headline}{  
      \leavevmode
      \begin{beamercolorbox}[wd=\paperwidth]{headline}
        \begin{columns}[T]
          \begin{column}{.015\paperwidth}
          \end{column}
          \begin{column}{.71\paperwidth}
            \vskip4ex
             \vspace{20pt}
            \raggedright
            {\usebeamerfont{title in headline}\usebeamercolor[fg]{title in headline}\inserttitle}
            {\usebeamerfont{title in headline}\usebeamercolor[fg]{title in headline}\insertsubtitle}
            %\usebeamercolor{title in headline}{\color{fg}\LARGE{\inserttitle}\\[1ex]}}

            \vspace{20pt}
            \usebeamercolor{author in headline}{\color{fg}\large{\insertauthor}\\[1ex]}
            \vspace{-5pt}
            \usebeamercolor{institute in headline}{\color{fg}\large{\insertinstitute}\\[1ex]}   
            \vspace{0pt}
          \end{column}
          \begin{column}{.226\paperwidth}
            \vskip11ex
            \vspace{-30pt}
            \begin{center}
             \hfill
%              \begin{columns}[T]
%                \begin{column}{16cm}
%                  \ifthenelse{\equal{\altlogo}{}}%
%                    {}%
%                    {%
%                      \includegraphics[height=9cm]{\altlogo}%
%                    }%
%                \end{column}
%
%                \begin{column}{9cm}
%                \end{column}
%              \end{columns}
                  \includegraphics[height=9cm]{oxweb-logo-square.png}

              %\begin{wrapfigure}{r}{0.35\linewidth}
                %\colorbox{white}{\includegraphics[width=.35\linewidth]{LiU_primary_black}} \\
                %\includegraphics[width=.35\linewidth]{uppsalalogo.png}
              %\end{wrapfigure}
            \end{center}
            \vskip2ex
          \end{column}
          \begin{column}{.02\paperwidth}
          \end{column}
        \end{columns}
        \vskip2ex
      \end{beamercolorbox}

      \begin{beamercolorbox}[wd=\paperwidth]{lower separation line head}
        \rule{0pt}{3pt}
      \end{beamercolorbox}
    }

    \setbeamertemplate{footline}{
      \begin{beamercolorbox}[wd=\paperwidth]{upper separation line foot}
        \rule{0pt}{3pt}
      \end{beamercolorbox}
      
      \leavevmode%
    %  \begin{beamercolorbox}[ht=2ex,leftskip=1em,rightskip=1em]{author in head/foot}%
    %    \texttt{\leftfoot}
    %    \hfill
    %    \texttt{\rightfoot}
    %    \vskip1ex
    %  \end{beamercolorbox}
      %\vskip0pt%
      %\begin{beamercolorbox}[wd=\paperwidth]{lower separation line foot}
      %  \rule{0pt}{3pt}
      %\end{beamercolorbox}
    }


    \setbeamertemplate{itemize items}[triangle]
    \setbeamertemplate{itemize item}{\raisebox{0.12ex}{$\blacktriangleright$}\hskip0.1em}
    \setbeamertemplate{itemize subitem}{\raisebox{0.12ex}{$\triangleright$}\hskip0.1em}
    % or define your own template using \defbeamertemplate{itemize item}, see beameruserguide.pdf

    % equal font sizes for all levels
    \setbeamerfont{itemize/enumerate body}{size=\normalsize}
    \setbeamerfont{itemize/enumerate subbody}{size=\normalsize}
    \setbeamerfont{itemize/enumerate subsubbody}{size=\normalsize}

    % set bibliography style
    %\setbeamertemplate{bibliography item}[text]
    %\setbeamercolor{bibliography item}{fg=black,bg=black}
    %\setbeamercolor{bibliography entry author}{fg=black,bg=black}
    %\setbeamercolor{bibliography item}{fg=black,bg=black}

    %\setbeamertemplate{bibliography entry title}{}
    %\setbeamertemplate{bibliography entry location}{}
    %\setbeamertemplate{bibliography entry note}{}
  }
  {}

% Get rid of navigation symbols
\setbeamertemplate{navigation symbols}{}

% Redefine vertical navigation to embolden the section heading of active subsections
\makeatletter
\def\insertverticalnavigation#1{%
  \vbox{%
    \def\sectionentry##1##2##3##4##5{%
      \ifnum##5=\c@part%
      \def\insertsectionhead{##2}%
      \def\insertsectionheadnumber{##1}%
      \def\insertpartheadnumber{##5}%
      \hbox to #1{{%
        \usebeamerfont{section in sidebar}\usebeamercolor[fg]{section in sidebar}%
          \hyperlink{Navigation##3}{%
          \ifnum\c@section=##1%
            \ifnum\c@subsection=0\relax%
              {\usebeamertemplate{section in sidebar}}%
            \else%
              {\usebeamertemplate{section in sidebar}}
            \fi%
          \else
            {\usebeamertemplate{section in sidebar shaded}}%
          \fi}}}%
      \beamer@currentsubsection=0\relax\fi}%
    \def\slideentry##1##2##3##4##5##6{}%
    \def\beamer@subsectionentry##1##2##3##4##5{%
      \ifnum##1=\c@part%
      \def\insertpartheadnumber{##1}%
      \def\insertsectionheadnumber{##2}%
      \def\insertsubsectionheadnumber{##3}%
      \def\insertsubsectionhead{##5}%
       \beamer@tocifnothide{\ifnum\c@section=##2\ifnum\c@subsection=##3\beamer@nav@css\else\beamer@nav@oss\fi\else\beamer@nav@ooss\fi}%
      {\hbox{{%
        \usebeamerfont{subsection in sidebar}\usebeamercolor[fg]{subsection in sidebar}%
          \hyperlink{Navigation##4}{%
          \ifnum\c@section=##2%
            \ifnum\c@subsection=##3%
              \ifnum\c@subsubsection=0\relax%
                {\usebeamertemplate{subsection in sidebar}}%
              \else%
                {\usebeamertemplate{subsection in sidebar shaded}}%
              \fi%
            \else%
              {\usebeamertemplate{subsection in sidebar shaded}}%
            \fi%
          \else%
            {\usebeamertemplate{subsection in sidebar shaded}}%
          \fi}}}%
      }%
      \fi}%
    \def\beamer@subsubsectionentry##1##2##3##4##5##6{%
      \ifnum##1=\c@part%
      \def\insertpartheadnumber{##1}%
      \def\insertsectionheadnumber{##2}%
      \def\insertsubsectionheadnumber{##3}%
      \def\insertsubsubsectionheadnumber{##4}%
      \def\insertsubsubsectionhead{##6}%
      \beamer@tocifnothide{\ifnum\c@section=##2\ifnum\c@subsection=##3\ifnum\c@subsubsection=##4\beamer@nav@css\else\beamer@nav@oss\fi\else\beamer@nav@ooss\fi\else\beamer@nav@ooss\fi}%
      {\hbox{{%
        \usebeamerfont{subsubsection in sidebar}\usebeamercolor[fg]{subsubsection in sidebar}%
          \hyperlink{Navigation##5}{%
          \ifnum\c@section=##2%
            \ifnum\c@subsection=##3%
              \ifnum\c@subsubsection=##4%
                {\usebeamertemplate{subsubsection in sidebar}}%
              \else
                {\usebeamertemplate{subsubsection in sidebar shaded}}%
              \fi%
            \else%
              {\usebeamertemplate{subsubsection in sidebar shaded}}%
            \fi%
          \else%
            {\usebeamertemplate{subsubsection in sidebar shaded}}%
          \fi}}}%
      }%
      \fi}%
    %\beamer@currentsubsection=0\relax%
    \dohead%
  }%
}

\newcommand{\sidebarlogo}{
  \vspace*{0.06cm}
  \hspace{0.03\beamer@sidebarwidth}
  \includegraphics[width=0.9\beamer@sidebarwidth]{oxweb-logo-square.png}%

  \ifthenelse{\equal{\altlogo}{}}%
    {}%
    {%
      \vspace*{0.1cm}%
      \hspace{0.03\beamer@sidebarwidth}
      \includegraphics[width=0.9\beamer@sidebarwidth]{\altlogo}%
    }%

  \beamer@tempdim=\beamer@sidebarwidth%
  \advance\beamer@tempdim by -6pt%
}

% Redefine sidebar to add logo and remove titles
\ifthenelse{\equal{\havesidebar}{true}}%
  {
    \setbeamertemplate{sidebar \beamer@sidebarside}
    {
      \sidebarlogo

      \insertverticalnavigation{\beamer@sidebarwidth}%
      \vfill
      \ifx\beamer@sidebarside\beamer@lefttext%
      \else%
        \usebeamercolor{normal text}%
        \llap{\usebeamertemplate***{navigation symbols}\hskip0.1cm}%
        \vskip2pt%
      \fi%
    }%
  }%
  {}

\makeatother

% Make sidebar section font bold
\setbeamerfont{section in sidebar}{series=\bfseries}

% Make footer
\ifthenelse{\equal{\havefootline}{true}}%
{%
  \setbeamertemplate{footline}{%
    \begin{beamercolorbox}[wd=\paperwidth,ht=0.15in,dp=0.075in,leftskip=0.5cm,rightskip=0.5cm]{footer}%
      \insertshorttitle\hfill%
      \ifthenelse{\equal{\haveframenumber}{true}}%
      {%
        \insertframenumber\hfill%
      }%
      {}%
      \insertshortauthor~~\insertshortinstitute
      % TODO: insert the conference name
      %\insertshortdate\hspace{1em}
    \end{beamercolorbox}%
  }%
}%
{
  \ifthenelse{\equal{\haveframenumber}{true}}%
  {%
    \setbeamertemplate{footline}{}
    \setbeamertemplate{page number in head/foot}[framenumber]
    \setbeamertemplate{navigation symbols}{\footnotesize\usebeamertemplate{page number in head/foot}\vspace{0.2em}}
    \addtocounter{framenumber}{-1}
  }%
  {}%
}%

% Write the date in the form 1st July 2010 rather than July 1, 2010
\renewcommand{\today}{%
  \ifcase\day\or
  1st\or 2nd\or 3rd\or 4th\or 5th\or
  6th\or 7th\or 8th\or 9th\or 10th\or
  11th\or 12th\or 13th\or 14th\or 15th\or
  16th\or 17th\or 18th\or 19th\or 20th\or
  21st\or 22nd\or 23rd\or 24th\or 25th\or
  26th\or 27th\or 28th\or 29th\or 30th\or
  31st\fi~\ifcase\month\or January\or February\or March\or
  April\or May\or June\or July\or August\or September\or October\or
  November\or December\fi \space \number\year%
}

% TODO: work out how to make this work with just plain old \titlepage
\newcommand{\makeoxfordtitle}{%
  {
    \setbeamercolor*{background canvas}{fg=OxfordPrimary,bg=OxfordPrimary}
    \setbeamercolor{titlelike}{fg=OxfordWhite}
    \setbeamercolor{author}{fg=OxfordDarkGrey}
    \setbeamercolor{institute}{fg=OxfordDarkGrey}
    \setbeamercolor{date}{fg=OxfordWhite}
    \setbeamercolor{part name}{fg=OxfordDarkGrey}
    \setbeamercolor{section name}{fg=OxfordDarkGrey}
    \setbeamercolor{subsection name}{fg=OxfordDarkGrey}

    % Display only the sidebar logo
    \ifthenelse{\equal{\havesidebar}{true}}%
      {\setbeamertemplate{sidebar left}{\sidebarlogo}}
      {}

    \setbeamertemplate{footline}{}
    \begin{frame}
      \titlepage

    \end{frame}
  }

% Set enumerate style
\setbeamertemplate{enumerate item}{(\arabic{enumi})}
\setbeamertemplate{enumerate subitem}{(\alph{enumi})}
\setbeamertemplate{enumerate subsubitem}{(\roman{enumi})}
}

% Make notes pdf when compiled with `-jobname notes`
\expandafter\ifstrequal\expandafter{\jobname}{notes}{
  \setbeameroption{show only notes}
}{
}

% Style the bibliography
\setbeamertemplate{bibliography item}{\insertbiblabel}
\setbeamerfont{bibliography item}{size=\footnotesize}
\setbeamerfont{bibliography entry author}{size=\footnotesize}
\setbeamerfont{bibliography entry title}{size=\footnotesize}
\setbeamerfont{bibliography entry location}{size=\footnotesize}
\setbeamerfont{bibliography entry note}{size=\footnotesize}
